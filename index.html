<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>🔒 دخول محمي</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{
    --bg1:#0f1724;
    --card:#fff;
    --accent:#2A9DF4;
    --muted:#6b7280;
  }
  *{box-sizing:border-box}
  body{
    margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
    background: linear-gradient(180deg,#071122 0%, #0b2540 100%);
    font-family: "Segoe UI", Roboto, Arial, sans-serif; color:var(--muted);
  }
  .wrap{width:100%;max-width:720px;padding:20px}
  .card{
    background:var(--card); border-radius:14px; padding:28px; box-shadow:0 12px 40px rgba(2,6,23,0.6);
    color:#0b1720; text-align:center;
  }
  h1{margin:0 0 8px 0; font-size:20px; color:var(--accent)}
  p.lead{margin:0 0 18px 0;color:#374151}
  .status{margin-top:12px;font-size:15px}
  .error { color:#b91c1c; font-weight:700; font-size:16px; }
  .buttons{display:flex;gap:12px;justify-content:center;margin-top:18px;flex-wrap:wrap}
  .btn{padding:10px 16px;border-radius:10px;text-decoration:none;color:white;font-weight:700}
  .tg{background:#2AABEE}
  .inst{background:#E1306C}
  .ghost{background:#f3f4f6;color:#0b1220;border:1px solid #e6eef9}
  .small{font-size:13px;color:#475569;margin-top:10px}
  @media (max-width:520px){
    .card{padding:18px}
    h1{font-size:18px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="card">
      <h1>🔒 التحقق من الصلاحية</h1>
      <p class="lead">يتم الآن التحقق من حسابك. افتح هذه الصفحة من داخل بوت تيليجرام حتى يعمل التحقق.</p>

      <div id="mainStatus" class="status">⏳ الرجاء الانتظار...</div>

      <div id="actions" style="display:none" class="buttons">
        <a id="tgBtn" class="btn tg" href="https://t.me/hx_ed" target="_blank" rel="noopener">📩 مراسلة عبر تيليجرام</a>
        <a id="igBtn" class="btn inst" href="https://www.instagram.com/hamedareqi" target="_blank" rel="noopener">📸 إنستجرام</a>
        <a id="retry" class="btn ghost" href="#" onclick="window.location.reload();return false;">🔁 إعادة المحاولة</a>
      </div>

      <div id="note" class="small">إذا ظهرت لك رسالة رفض: تواصل معي لطلب الإذن.</div>
    </div>
  </div>

<script>
  (function(){
    const mainStatus = document.getElementById('mainStatus');
    const actions = document.getElementById('actions');

    // Raw JSON file (استخدم رابطك كما وضعته)
    const allowedJSON = "https://raw.githubusercontent.com/hamedareqi/EnglishQuiz/refs/heads/main/allowed.json";

    // محاولة الحصول على كائن Telegram WebApp؛ إذا لم يكن داخل Telegram، سنضع user = null
    let tg = null;
    try { tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null; } catch(e){ tg = null; }

    // Helper لتظهر رسالة خطأ
    function showDenied(msg){
      mainStatus.innerHTML = `<span class="error">❌ ${msg}</span>`;
      actions.style.display = 'flex';
    }

    // إذا لم تُفتح الصفحة داخل Telegram WebApp
    if(!tg){
      mainStatus.innerText = "⚠️ هذه الصفحة يجب أن تُفتح من داخل تطبيق Telegram (WebApp).";
      actions.style.display = 'flex';
      return;
    }

    // توسيع الويب آب لعرض أفضل
    try{ tg.expand(); }catch(e){}

    // احصل على بيانات المستخدم من WebApp (غير موقعة)
    const user = tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user : null;
    if(!user){
      showDenied("لم نستطع الحصول على بيانات المستخدم من Telegram. افتح الصفحة من داخل البوت.");
      return;
    }

    mainStatus.innerText = `🔎 نتحقق من ID: ${user.id} — ${user.first_name || ''}`;

    // جلب قائمة المصرح لهم من GitHub
    fetch(allowedJSON, {cache: "no-store"})
      .then(res => {
        if(!res.ok) throw new Error("فشل جلب ملف الأذونات");
        return res.json();
      })
      .then(json => {
        const ids = Array.isArray(json.allowed_ids) ? json.allowed_ids.map(id => Number(id)) : [];
        if(ids.includes(Number(user.id))){
          // مسموح → إعادة التوجيه للصفحة الداخلية
          mainStatus.innerHTML = `✅ تم التحقق — جاري تحويلك…`;
          // تأخير قصير لإظهار الرسالة ثم الانتقال
          setTimeout(()=> {
            // تحويل إلى welcome.html داخل نفس المستودع/موقع الاستضافة
            // تأكد أن welcome.html في نفس المسار على GitHub Pages أو استضافتك
            window.location.href = "welcome.html";
          }, 700);
        } else {
          showDenied("عذراً، ليس لديك إذن للوصول. تواصل معنا للحصول على الإذن.");
        }
      })
      .catch(err => {
        console.error(err);
        showDenied("حدث خطأ أثناء التحقق، حاول لاحقًا.");
      });

  })();
</script>
</body>
</html>
